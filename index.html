<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="bootstrap.min.css">
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="jquery-3.4.1.min.js"></script>
        <script src="popper.min.js"></script>
        <script src="bootstrap.min.js"></script>
        <!-- FONT AWESOME -->
        <link rel="stylesheet" href="fa/css/all.min.css">
        <!-- Bootstrap datepicker -->
        <link rel="stylesheet" href="datepicker/css/bootstrap-datepicker.min.css">
        <script src="datepicker/js/bootstrap-datepicker.min.js"></script>
        <script src="datepicker/locales/bootstrap-datepicker.id.min.js"></script>
        <!-- Datatables -->
        <link rel="stylesheet" href="dataTables.bootstrap4.min.css">
        <link rel="stylesheet" href="responsive.bootstrap4.min.css">
        <script src="jquery.dataTables.min.js"></script>
        <script src="dataTables.bootstrap4.min.js"></script>
        <script src="processing.js"></script>
        <!-- Select2 -->

        <!-- Vue etc -->
        <script src="vue.js"></script>
        <script src="vue-router.js"></script>


        <title>VUE Playground by Bowie</title>
    </head>
    <body>
        <div id="app">
            <div class="container">
                <h1>Datepicker</h1>
                <router-link to="/about">go home</router-link>
                <datepicker v-model="tgl"></datepicker>
                <p>
                    The name inside is {{ name }}, and tgl = {{ tgl }}
                    <!-- <router-link to="/cd">CD</router-link> -->
                </p>
                <div>
                    <input type="text" v-model="tgl" class="form-control"/>
                </div>
                <hr>
                <h1>Datatables (penumpang)</h1>
                <div>
                    <penumpang-datatable 
                        url="http://192.168.146.23/apishinta/public/penumpang" 
                        token="token_pdtt"
                        :editable="true"
                        @edit="doEdit" 
                        @view="doView" 
                        @delete="doDelete"></penumpang-datatable>
                </div>
                <hr>
                <h1>Datatables (Customs Declaration)</h1>
                <div>
                    <cd-datatable 
                        url="http://192.168.146.23/apishinta/public/dokumen/cd" 
                        token="token_pdtt" 
                        :editable="true" 
                        :appendable="true"
                        @edit="doEdit" 
                        @view="doView" 
                        @delete="doDelete"></cd-datatable>
                </div>
            </div>
            
        </div>

        <!-- MIXINS: JSON ERROR -->
        <script>
            var jsonMixin = {
                methods: {
                    handleAjaxError: function(jqXhr) {
                        var msg = "";
                        if (jqXhr.responseJSON) {
                            msg = "error: (" + jqXhr.responseJSON.error.http_code
                                + ")\n" + jqXhr.responseJSON.error.message;
                        } else {
                            msg = "Unknown error: could be caused by connection.";
                        }

                        alert(msg);
                    }
                }
            };
        </script>

        <!-- MIXINS: DATATABLE COMPONENT -->
        <script>
            var dtMixin = {
                props: {
                    editable: {
                        type: Boolean,
                        default: false
                    },
                    appendable: {
                        type: Boolean,
                        default: true
                    }
                },
                data: function() {
                    return {
                        dt: null
                    };
                },
                methods: {
                    refresh: function() {
                        this.dt.draw();
                    },
                    spawnDataControl: function(data) {
                        var html='<div class="btn-group" role="group">'
                            + 
                            ( 
                            this.editable ? 
                            '<button type="button" class="btn btn-sm btn-primary" data-action="edit" data-id="'+ data +'"><i class="fa fa-edit"></i></button>'
                            + '<button type="button" class="btn btn-sm btn-danger" data-action="delete" data-id="'+ data +'"><i class="fa fa-trash"></i></button>'
                            : '<button type="button" class="btn btn-sm btn-primary" data-action="view" data-id="'+ data +'"><i class="fa fa-eye"></i></button>'
                            )
                            +
                            '</div>';
                        return html;
                    },
                    showProcessing: function (v) {
                        // console.log(this.dt);
                        this.dt.processing(v);
                    },
                    initDatatable () {
                        var vm = this;
                        // action button click handler
                        $(this.$refs.tbl).on('click', 'button[data-action="view"], button[data-action="edit"], button[data-action="delete"]', function(e) {
                            var action = $(e.currentTarget).data('action');
                            var id = $(e.currentTarget).data('id');

                            // alert(action + '@' + id);
                            vm.$emit(action, id);

                            // alert(JSON.stringify(e));
                            // console.log(e);
                        });
                    }
                }
            };
        </script>

        <!-- COMPONENT: DATEPICKER -->
        <script>
            Vue.component('datepicker', {
                props: ['value'],
                template: `
                    <div class="input-group date mb-3">
                        <input type="text" class="form-control" ref="dp">
                        <div class="input-group-append">
                            <button class="btn btn-primary"><i class="fa fa-calendar-alt"></i></button>
                        </div>
                    </div>
                `,
                watch: {
                    value: function(newVal, oldVal) {
                        $(this.$el).datepicker('update', newVal);
                    }
                },
                mounted() {
                    var vm = this;
                    $(this.$el).datepicker({
                        format: 'dd-mm-yyyy',
                        autoclose: true,
                        language: 'id',
                        weekStart: 1,
                        todayHighlight: true
                    }).on('changeDate', function(e) {
                        vm.$emit('input', vm.$refs.dp.value);
                    });

                    $(this.$el).datepicker('update', this.value);
                },
                destroyed() {
                    $(this.$el).datepicker('destroy');
                }
            });
        </script>

        <!-- COMPONENT: PENUMPANG-DATATABLE -->
        <script>
            Vue.component('penumpang-datatable', {
                props: {
                    url: String,
                    token: {
                        type: String,
                        required: true
                    },
                    searchDelay: {
                        type: Number,
                        default: 800
                    },
                    searchPlaceholder: {
                        type: String,
                        default: "Nama/asal/no paspor/etc"
                    },
                    timeout: {
                        type: Number,
                        default: 30000
                    }
                },
                mixins: [jsonMixin, dtMixin],
                template: `
                    <div>
                        <div class="mb-2">
                            <router-link to="/penumpang/new" class="btn btn-primary" v-if="appendable">Input Penumpang <i class="fa fa-plus-circle"></i></router-link>
                        </div>
                        <table ref="tbl" class="table table-striped table-bordered dt-responsive" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Tgl Lahir</th>
                                    <th>No Paspor</th>
                                    <th>Kebangsaan</th>
                                    <th>Pekerjaan</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                `,
                mounted() {
                    var vm=this;

                    this.initDatatable();

                    this.dt = $(this.$refs.tbl).DataTable({
                        language: {
                            search: "_INPUT_",
                            searchPlaceholder: vm.searchPlaceholder
                        },
                        searchDelay: vm.searchDelay,
                        rowId: 'id',
                        ajax: {
                            url: vm.url,
                            type: 'GET',
                            crossDomain: true,
                            timeout: vm.timeout,
                            data: function(d) {
                                var page = Math.ceil(d.start/d.length) + 1;
                                return "q=" + d.search.value + "&number=" + d.length + "&page=" + page;
                            },
                            dataType: 'json',
                            processData: false,
                            beforeSend: function(xhr) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + vm.token );
                            },
                            error: function(a, b, c) {
                                console.log(a);
                                
                                // alert(a.statusCode());
                                // console.log(a.statusCode());
                                // var txtMessage = a.status + ": " + a.responseText;
                                // alert(txtMessage);
                                vm.handleAjaxError(a);
                                vm.dt.processing(false);
                            }
                        },
                        columns: [
                            { data: 'nama', orderable: false},
                            { data: 'tgl_lahir', orderable: false},
                            { data: 'no_paspor', orderable: false},
                            { data: 'kebangsaan', orderable: false},
                            { data: 'pekerjaan', orderable: false},
                            {
                                data: 'id',
                                orderable: false,
                                render: function(data, type, row, meta) {
                                    return vm.spawnDataControl(data);
                                }
                            }
                        ],
                        processing: true,
                        serverSide: true
                    });
                },
                destroyed() {
                    this.dt.destroy();
                }
            });
        </script>

        <!-- COMPONENT: CD-DATATABLE -->
        <script>
            Vue.component('cd-datatable', {
                props: {
                    url: String,
                    token: {
                        type: String,
                        required: true
                    },
                    searchDelay: {
                        type: Number,
                        default: 800
                    },
                    searchPlaceholder: {
                        type: String,
                        default: "Keyword pencarian..."
                    },timeout: {
                        type: Number,
                        default: 30000
                    }
                },
                mixins: [jsonMixin, dtMixin],
                methods: {
                    spawnDeclareBadge: function (str) {
                        // spawn elemeent based on de string
                        var style = "badge-primary";
                        switch (str) {
                            case "KARANTINA":
                                style = "badge-primary";
                                break;
                            case "NARKOTIKA":
                                style = "badge-danger";
                                break;
                            case "UANG":
                                style = "badge-success";
                                break;
                            case "KOMERSIL":
                                style = "badge-warning";
                                break;
                            case "BKC":
                                style = "badge-dark";
                                break;
                            case "IMPOR_UNTUK_DIPAKAI":
                                style = "badge-info";
                                break;
                            default:
                                style = "badge-secondary";
                        }

                        return '<span class="badge '+ style +'">' + str + '</span>';
                    }
                },
                template: `
                    <div>
                        <div class="mb-2">
                            <router-link to="/cd/new" class="btn btn-primary" v-if="appendable">Input CD <i class="fa fa-plus-circle"></i></router-link>
                        </div>
                        <table ref="tbl" class="table table-sm table-striped table-bordered dt-responsive" style="width:100%">
                            <thead>
                                <tr>
                                    <th>No dok</th>
                                    <th>Tanggal</th>
                                    <th>Lokasi</th>
                                    <th>Penumpang</th>
                                    <th>No flight</th>
                                    <th>Tgl tiba</th>
                                    <th>Jml Barang</th>
                                    <th>Flags</th>
                                    <th>Terkunci?</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                `,
                mounted() {
                    var vm=this;

                    this.initDatatable();

                    this.dt = $(this.$refs.tbl).DataTable({
                        language: {
                            search: "_INPUT_",
                            searchPlaceholder: vm.searchPlaceholder
                        },
                        searchDelay: vm.searchDelay,
                        rowId: 'id',
                        ajax: {
                            url: vm.url,
                            type: 'GET',
                            timeout: vm.timeout,
                            crossDomain: true,
                            data: function(d) {
                                var page = Math.ceil(d.start/d.length) + 1;

                                // console.log(d);

                                return "q=" + d.search.value + "&number=" + d.length + "&page=" + page;
                            },
                            dataType: 'json',
                            processData: false,
                            beforeSend: function(xhr) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + vm.token );
                            },
                            error: function(a) {
                                handleAjaxError(a);
                                this.dt.processing(false);
                            }
                        },
                        columns: [
                            { data: 'nomor_lengkap', orderable: false},
                            { data: 'tgl_dok', orderable: false},
                            { data: 'lokasi', orderable: false},
                            { data: 'penumpang.data.nama', orderable: false},
                            { data : 'no_flight', orderable: false},
                            { data : 'tgl_kedatangan', orderable: false},
                            { data: 'jumlah_detail', orderable: false},
                            { 
                                data: 'declare_flags', 
                                orderable: false,
                                render: function(data, type, row, meta) {
                                    var html = '';

                                    for (var i=0; i<data.length; i++) {
                                        html += vm.spawnDeclareBadge(data[i]) + ' ';
                                    }

                                    return html;
                                }
                            },
                            { 
                                data: 'is_locked', 
                                orderable: false,
                                render: function(data, type, row, meta) {
                                    // gambar badge dengan icon konci
                                    if (data) {
                                        return '<span class="badge badge-danger">YA <i class="fa fa-lock"></i></span>';
                                    } else {
                                        return '<span class="badge badge-primary">TIDAK <i class="fa fa-lock-open"></i></span>';
                                    }
                                }
                            },
                            {
                                data: 'id',
                                orderable: false,
                                render: function(data, type, row, meta) {
                                    // console.log(row);
                                    return vm.spawnDataControl(data);
                                }
                            }
                        ],
                        processing: true,
                        serverSide: true
                    });
                },
                destroyed() {
                    this.dt.destroy();
                }
            });
        </script>

        <!-- COMPONENT: SELECT-PENUMPANG -->
        <script>
            Vue.component('select-penumpang', {
                template: `
                <select><slot></slot></select>
                `,
                props: ['url', 'options', 'value', 'token'],
                data() {
                    return {};
                },
                mounted() {
                    var vm = this;
                    $(this.$el)
                        .select2({ data: this.options })
                        .val(this.value)
                        .trigger('change')
                        .on('change', function () {
                            vm.$emit('input', this.value);
                        });
                },
                destroyed() {
                    $(this.$el).off().select2('destroy');
                },
                watch: {

                }
            });
        </script>

        <!-- COMPONENT: APP -->
        <script>
            const routes = [
                
            ];

            const router = new VueRouter({
                routes
            });

            new Vue({
                el: '#app',
                router,
                data: {
                    counter: 0,
                    name: "Bowie",
                    tgl: '21-09-2019',
                    token: 'token_admin'
                },
                methods: {
                    doEdit: function (id) {
                        alert("Must edit data@"+id);
                    },
                    doView: function (id) {
                        alert("Must view data@"+id);
                    },
                    doDelete: function (id) {
                        alert("Must delete data@"+id);
                    }
                }
            });
        </script>
    </body>
    <footer class="container mt-3">
        Copyright <a href="mailto:bowvernon110391@gmail.com">bowvernon110391@gmail.com</a>
    </footer>
</html>